{{- /* Related works nederst på enkeltsider i /works */ -}}
{{- if and (eq .Section "works") (not .Draft) -}}
  {{- $page := . -}}
  {{- $pool := where site.RegularPages "Section" "works" -}}
  {{- $pool = where $pool "Permalink" "ne" $page.Permalink -}}

  {{- /* find matches på categories og tags */ -}}
  {{- $byCats := slice -}}
  {{- with $page.Params.categories -}}
    {{- $byCats = where $pool "Params.categories" "intersect" . -}}
  {{- end -}}
  {{- $byTags := slice -}}
  {{- with $page.Params.tags -}}
    {{- $byTags = where $pool "Params.tags" "intersect" . -}}
  {{- end -}}

  {{- $choices := (union $byCats $byTags) | uniq -}}
  {{- $related := cond (gt (len $choices) 0) (first 6 $choices) (first 6 (sort $pool "Date" "desc")) -}}

  {{- with $related -}}
  <section class="mt-10 pt-6 border-t">
    <h2 class="text-xl font-semibold mb-4">Related works</h2>
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
      {{- range . -}}
        <a class="group block" href="{{ .RelPermalink }}" aria-label="{{ .Title }}">
          {{- $res := false -}}
          {{- with .Params.cover.image -}}
            {{- $res = (.Resources.GetMatch (printf "*%s*" .)) -}}
          {{- end -}}
          {{- if $res -}}
            {{- $thumb := $res.Fit "600x400 q75" -}}
            <figure class="rounded-lg overflow-hidden aspect-[4/3]">
              <img loading="lazy" decoding="async"
                   src="{{ $thumb.RelPermalink }}"
                   alt="{{ $.Title }}"
                   class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
            </figure>
          {{- else -}}
            {{- with .Params.cover.image -}}
              <figure class="rounded-lg overflow-hidden aspect-[4/3]">
                <img loading="lazy" decoding="async"
                     src="{{ . | relURL }}"
                     alt="{{ $.Title }}"
                     class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
              </figure>
            {{- end -}}
          {{- end -}}
          <p class="mt-2 text-sm opacity-80 group-hover:opacity-100">{{ .Title }}</p>
        </a>
      {{- end -}}
    </div>
  </section>
  {{- end -}}
{{- end -}}
