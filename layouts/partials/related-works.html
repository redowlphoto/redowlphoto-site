{{/* Related works: robust mod manglende cover.image */}}
{{- $page := . -}}
{{- $all  := where site.RegularPages "Section" "works" -}}

{{- $cats := $page.Params.categories | default (slice) -}}
{{- $tags := $page.Params.tags        | default (slice) -}}

{{- $byCat := where $all "Params.categories" "intersect" $cats -}}
{{- $byTag := where $all "Params.tags"        "intersect" $tags -}}
{{- $pool  := union $byCat $byTag -}}
{{- $pool  = where $pool "RelPermalink" "ne" $page.RelPermalink -}}
{{- $pool  = first 6 (uniq $pool) -}}

{{- if gt (len $pool) 0 -}}
  {{- range $pool -}}
    {{- $thumb := "" -}}
    {{- $imgPath := "" -}}
    {{- with .Params.cover }}{{ with .image }}{{ $imgPath = . }}{{ end }}{{ end -}}
    {{- if $imgPath }}
      {{- with .Resources.GetMatch (printf "*%s" (path.Base $imgPath)) -}}
        {{- $r := .Fit "800x450 q80" -}}
        {{- $thumb = $r.RelPermalink -}}
      {{- end -}}
    {{- end -}}

    <a class="ro-card" href="{{ .RelPermalink }}" title="{{ .Title }}">
      {{- if $thumb -}}
        <img src="{{ $thumb }}" alt="{{ .Title }}" loading="lazy" decoding="async">
      {{- else -}}
        <div class="ro-ph">{{ .Title }}</div>
      {{- end -}}
      <span class="ro-card-label">{{ .Title }}</span>
    </a>
  {{- end -}}
{{- end -}}
