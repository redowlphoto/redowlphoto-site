{{/* Related works: robust mod manglende cover.image */}}
{{- $page := . -}}
{{- $all  := where site.RegularPages "Section" "works" -}}

{{- $cats := $page.Params.categories | default (slice) -}}
{{- $tags := $page.Params.tags        | default (slice) -}}

{{- $byCat := where $all "Params.categories" "intersect" $cats -}}
{{- $byTag := where $all "Params.tags"        "intersect" $tags -}}
{{- $pool  := union $byCat $byTag -}}
{{- $pool  = where $pool "RelPermalink" "ne" $page.RelPermalink -}}
{{- $pool  = first 6 (uniq $pool) -}}

{{- if gt (len $pool) 0 -}}
  <div class="ro-related">
    <h2>Related Works</h2>
    <div class="ro-grid">
      {{- range $pool -}}
        {{- $thumb := "" -}}
        {{- $imgPath := "" -}}
        {{- with .Params.cover }}{{ with .image }}{{ $imgPath = . }}{{ end }}{{ end -}}
        {{- if $imgPath }}
          {{- with .Resources.GetMatch (printf "*%s" (path.Base $imgPath)) -}}
            {{- $r := .Resize "400x q80" -}}
            {{- $thumb = $r.RelPermalink -}}
          {{- end -}}
        {{- end -}}
        <a class="ro-card" href="{{ .RelPermalink }}">
          {{- if $thumb -}}<img src="{{ $thumb }}" alt="{{ .Title }}">{{- end -}}
          <div class="ro-card-title">{{ .Title }}</div>
        </a>
      {{- end -}}
    </div>
  </div>
{{- end -}}
